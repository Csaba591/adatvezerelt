


<!doctype html>
<html lang="hu" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <meta name="author" content="Dudás Ákos">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.4.0">
    
    
      
        <title>JPA & Spring Data - BMEVIAUAC01 Adatvezérelt rendszerek</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.fe0cca5b.min.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/palette.a46bcfb3.min.css">
      
      
        
        
        <meta name="theme-color" content="#ef5350">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../extra-material-theme.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="red" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#jpa-spring-data" class="md-skip">
          Kihagyás
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="BMEVIAUAC01 Adatvezérelt rendszerek" class="md-header-nav__button md-logo" aria-label="BMEVIAUAC01 Adatvezérelt rendszerek">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            BMEVIAUAC01 Adatvezérelt rendszerek
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              JPA & Spring Data
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Keresés" placeholder="Keresés" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/bmeviauac01/adatvezerelt/" title="Főoldalra ugrás" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    bmeviauac01/adatvezerelt
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
          

<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../.." class="md-tabs__link md-tabs__link--active">
        Adatvezérelt rendszerek
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../db/" class="md-tabs__link">
          Adatbázis
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../jegyzet/architektura/" class="md-tabs__link">
          Jegyzetek
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="BMEVIAUAC01 Adatvezérelt rendszerek" class="md-nav__button md-logo" aria-label="BMEVIAUAC01 Adatvezérelt rendszerek">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    BMEVIAUAC01 Adatvezérelt rendszerek
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/bmeviauac01/adatvezerelt/" title="Főoldalra ugrás" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    bmeviauac01/adatvezerelt
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Adatvezérelt rendszerek" class="md-nav__link">
      Adatvezérelt rendszerek
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Adatbázis
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Adatbázis" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Adatbázis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/" title="Minta adatbázis sémája" class="md-nav__link">
      Minta adatbázis sémája
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/mssql/" title="Microsoft SQL Server használata" class="md-nav__link">
      Microsoft SQL Server használata
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/mongodb/" title="MongoDB használata" class="md-nav__link">
      MongoDB használata
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/mssql.sql" title="mssql.sql" class="md-nav__link">
      mssql.sql
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/mongo.js" title="mongodb.js" class="md-nav__link">
      mongodb.js
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Jegyzetek
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Jegyzetek" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Jegyzetek
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../jegyzet/architektura/" title="Adatvezérelt rendszerek és a többrétegű (háromrétegű) architektúra" class="md-nav__link">
      Adatvezérelt rendszerek és a többrétegű (háromrétegű) architektúra
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jegyzet/transactions/" title="Tranzakciókezelés adatbázisokban" class="md-nav__link">
      Tranzakciókezelés adatbázisokban
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jegyzet/mssql/sql/" title="SQL nyelv, MSSQL platformfüggő SQL utasítások" class="md-nav__link">
      SQL nyelv, MSSQL platformfüggő SQL utasítások
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jegyzet/mssql/server-side-programming/" title="Microsoft SQL Server programozása" class="md-nav__link">
      Microsoft SQL Server programozása
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jegyzet/linq/" title="LINQ: Language Integrated Query" class="md-nav__link">
      LINQ: Language Integrated Query
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jegyzet/mongodb/" title="MongoDB műveletek és a MongoDB .NET Driver" class="md-nav__link">
      MongoDB műveletek és a MongoDB .NET Driver
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jegyzet/dependency-injection/index.md" title="None" class="md-nav__link">
      None
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://github.com/bmeviauac01/rest-webapi-sample" title="REST és WebAPI demó alkalmazás" class="md-nav__link">
      REST és WebAPI demó alkalmazás
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://github.com/bmeviauac01/todoapi-di-sample" title="ASP.NET Core DI demó alkalmazás" class="md-nav__link">
      ASP.NET Core DI demó alkalmazás
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://github.com/bmeviauac01/threelayered-aspnetcore-sample" title="Minta többrétegű webalkalmazás" class="md-nav__link">
      Minta többrétegű webalkalmazás
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Tartalomjegyzék">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Tartalomjegyzék
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#celkituzes" class="md-nav__link">
    Célkitűzés
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#elofeltetelek" class="md-nav__link">
    Előfeltételek
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#amit-erdemes-atnezned" class="md-nav__link">
    Amit érdemes átnézned
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gyakorlat-menete" class="md-nav__link">
    Gyakorlat menete
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tippek-az-eclipse-hasznalatahoz" class="md-nav__link">
    Tippek az Eclipse használatához
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#feladat-0-adatbazis-letrehozasa" class="md-nav__link">
    Feladat 0: Adatbázis létrehozása
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#feladat-1-eclipse-inditasa" class="md-nav__link">
    Feladat 1: Eclipse indítása
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#feladat-2-projekt-importalasa" class="md-nav__link">
    Feladat 2: Projekt importálása
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#feladat-3-entitasok-attekintese" class="md-nav__link">
    Feladat 3: Entitások áttekintése
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#feladat-4-lekerdezesek" class="md-nav__link">
    Feladat 4: Lekérdezések
  </a>
  
    <nav class="md-nav" aria-label="Feladat 4: Lekérdezések">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#futtatas" class="md-nav__link">
    Futtatás
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#feladat-5-adatmodositas" class="md-nav__link">
    Feladat 5: Adatmódosítás
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#feladat-6-tarolt-eljarasok-hasznalata" class="md-nav__link">
    Feladat 6: Tárolt eljárások használata
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/bmeviauac01/adatvezerelt/edit/master/docs/gyakorlat/Gyak-JPA/README.md" title="Oldal szerkesztése" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="jpa-spring-data">JPA &amp; Spring Data<a class="headerlink" href="#jpa-spring-data" title="Permanent link">&para;</a></h1>
<h2 id="celkituzes">Célkitűzés<a class="headerlink" href="#celkituzes" title="Permanent link">&para;</a></h2>
<p>A gyakorlat célja, hogy a hallgatók megismerjék a JPA és a Spring Data használatát. A főbb témák: entitások fejlesztése, lekérdezések megfogalmazása különböző módokon, módosítások végrehajtása. A kódokat egy webalkalmazás projektbe integráljuk, amiben a projekt alapvető konfigurációja és egy teszteléshez használható egyszerű webes felületet már készen áll.</p>
<h2 id="elofeltetelek">Előfeltételek<a class="headerlink" href="#elofeltetelek" title="Permanent link">&para;</a></h2>
<p>A labor elvégzéséhez szükséges eszközök:</p>
<ul>
<li>Eclipse for Java EE</li>
<li>Microsoft SQL Server Express edition (localdb nem alkalmas)</li>
<li>SQL Server Management Studio</li>
<li>Adatbázis létrehozó script: <a href="https://raw.githubusercontent.com/bmeviauac01/gyakorlatok/master/mssql.sql">mssql.sql</a></li>
<li>Kiinduló webalkalmazás kódja: <a href="https://github.com/bmeviauac01/gyakorlat-seminar-jpa-starter">https://github.com/bmeviauac01/gyakorlat-seminar-jpa-starter</a></li>
<li>Az MSSQL JDBC driver letöltése innen: <a href="https://www.aut.bme.hu/Upload/Course/adatvezerelt/gyakorlat_anyagok/mssql-jdbc.zip">https://www.aut.bme.hu/Upload/Course/adatvezerelt/gyakorlat_anyagok/mssql-jdbc.zip</a></li>
<li>A zipet csomagold ki ide: <code>c:\work\javaee\.m2\repository</code> (a zip egy <em>com</em> nevű könyvtárat tartalmaz, az elvárt végeredmény egy ilyen könyvtárstruktúra: <code>c:\work\javaee\.m2\repository\com\microsoft\...</code>)</li>
</ul>
<h2 id="amit-erdemes-atnezned">Amit érdemes átnézned<a class="headerlink" href="#amit-erdemes-atnezned" title="Permanent link">&para;</a></h2>
<ul>
<li>JPA előadás</li>
<li>EJB, Spring előadás</li>
</ul>
<h2 id="gyakorlat-menete">Gyakorlat menete<a class="headerlink" href="#gyakorlat-menete" title="Permanent link">&para;</a></h2>
<p>A gyakorlat végig vezetett, a gyakorlatvezető utasításai szerint haladjunk. Egy-egy részfeladatot próbáljunk meg először önállóan megoldani, utána beszéljük meg a megoldást közösen. Az utolsó feladat opcionális, ha belefér az időbe.</p>
<p>Emlékeztetőként a megoldások is megtalálhatóak az útmutatóban is. Előbb azonban próbáljuk magunk megoldani a feladatot!</p>
<h2 id="tippek-az-eclipse-hasznalatahoz">Tippek az Eclipse használatához<a class="headerlink" href="#tippek-az-eclipse-hasznalatahoz" title="Permanent link">&para;</a></h2>
<ul>
<li>Típus (osztály, interfész, enum) keresése: Ctrl+Shift+T (Nem érdemes a Project explorer-ben a mappákat nyitogatni)</li>
<li>Fájl keresése: Ctrl+Shift+R</li>
<li>Hiányzó importok megjavítása: Ctrl+Shift+O</li>
<li>Kód formázása: Ctrl+Shift+F</li>
<li>Ha a Java Resources alatt egy package-en jobb klikk / New Class/Interfaces, akkor abba a package-be rakja az új elemet by
  default</li>
<li>Ha a nézeteket becsukjuk/átrendezzük, a default elrendezés visszaállítható: Window / Reset perspective</li>
<li>Font megnövelése (a tanári gépen hasznos):</li>
<li>Window menü / Preferences, ott elkezdjük gépelni, hogy <em>font</em>, így megtalálja azt a beállítást, hogy Fonts and Colors</li>
<li>Azt kiválasztva, a Basic kategória alatt kell a Text Fontot kijelölni, és a méretét pl. 18-asra állítani</li>
</ul>
<h2 id="feladat-0-adatbazis-letrehozasa">Feladat 0: Adatbázis létrehozása<a class="headerlink" href="#feladat-0-adatbazis-letrehozasa" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>Csatlakozzunk <em>Microsoft SQL Server Management Studio</em>-val a a szerverhez. Ezúttal nem <em>localdb</em>-t használunk, a szerver címe: <code>localhost\sqlexpress</code>. A bejelentkezéshez <em>SQL Server Authentication</em> módot válasszuk.</p>
</li>
<li>
<p>Hozzunk létre egy <code>adatvez</code> nevű adatbázist (ügyeljünk a névre, különben a Java projektben módosítanunk kell). Az adatbázis létrehozásának mikéntjét lásd az első gyakorlat anyagában. Ha a gépen már létezik az adatbázis, akkor nem kell újat létrehozni.</p>
</li>
<li>
<p>Futtassuk le az adatbázis inicializáló sql szkriptet az adatbázisban. Akkor is futtassuk le a szkriptet, ha már létezne az adatbázis (hogy a kezdeti állapotot visszakapjuk.)</p>
</li>
</ol>
<h2 id="feladat-1-eclipse-inditasa">Feladat 1: Eclipse indítása<a class="headerlink" href="#feladat-1-eclipse-inditasa" title="Permanent link">&para;</a></h2>
<ol>
<li>Indítsuk el az Eclipse-et innen: <code>C:\Work\javaee\eclipse\eclipse.exe</code>. (Fontos, hogy lehet egy <code>D:\eclipse</code> mappa is, nekünk <em>nem</em> az kell.)</li>
<li>Indításkor megkérdezi, hova akarunk dolgozni (workspace), itt válasszuk ezt: <code>C:\Work\javaee\workspaces\adatvez</code></li>
<li>Ha az indulás után a Project Explorer-ben ott van egy korábbi gyakorlatról a <strong>webshop</strong> nevű projekt, azt töröljük ki: a projekten jobb klikk / <em>Delete</em>, amikor rákérdez, pipáljuk be, hogy a fájlrendszerről is törlődjön.</li>
</ol>
<h2 id="feladat-2-projekt-importalasa">Feladat 2: Projekt importálása<a class="headerlink" href="#feladat-2-projekt-importalasa" title="Permanent link">&para;</a></h2>
<ol>
<li>Töltsük le a méréshez tartozó projekt vázat!</li>
<li>Nyissunk egy <em>command prompt</em>-ot</li>
<li>Navigáljunk el egy tetszőleges mappába, például <code>c/d:\work\NEPTUN</code></li>
<li>Adjuk ki a következő parancsot: <code>git clone --depth 1 https://github.com/bmeviauac01/gyakorlat-seminar-jpa-starter.git</code></li>
<li>Importáljuk a letöltött forráskódot a workspace-be:</li>
<li>Nyissuk meg a <em>File / Import...</em>-ot</li>
<li>Kezdjük el gépelni a textboxba, hogy <em>Existing projects into workspace</em>, így rá fog szűrni és válasszuk ki ezt</li>
<li>Keressük meg a kicsomagolt webshop projektet (a <code>webshop</code> mappát a saját könyvtárunk alatt), OK, utána a dialogban pipáljuk be a webshop-ot (lehet, hogy by default be lesz pipálva)</li>
<li>Finish</li>
<li>
<p>Tekintsük át röviden a projektet:</p>
</li>
<li>
<p>Ez egy <em>maven</em> alapú projekt. A maven parancssori build eszköz, ami IDE-khez is illeszthető. Fontos tulajdonsága, hogy képes a szükséges library függőségeket online repository-kból letölteni. Ha megnyitjuk a projekt gyökerében <code>pom.xml</code>-t, a maven konfig fájlját, dependency tagekben függőségeket látunk, amik (tranzitív módon) behúzzák a <em>Hibernate</em>-et mint JPA implementációt, a <em>Spring Boot</em>-ot, a <em>Spring Data</em>-t és a webréteghez szükséges <em>Spring MVC</em>-t és <em>Thymeleaf</em>-et. A laborban a maven offline működésre van konfigurálva, és előre le van töltve az összes függőség, így megelőzzük az esetleges hálózati problémákat.</p>
</li>
<li>
<p>Az <em>application.properties</em>-ben van pár alapvető beállítás, itt a DB eléréshez <strong>ellenőrizzük a usernevet és jelszót</strong>. Figyeljük meg az adatbázis JNDI nevének beállításához ezt a sort: <code>spring.datasource.jndi-name=jdbc/termekDB</code>. Klasszikus Java EE alkalmazásban ezt a <code>persistence.xml</code>-be írnánk be, de a Spring Boot XML nélküli konfigurációt is támogat, itt ezt használjuk ki. (Egy apróság: a projektben mégis van <code>persistence.xml</code>, ezt igényli az Eclipse-es JPA plugin, aminek köszönhetően pl. kódkiegészítés működik a NamedQuery-kben. Viszont, mivel igazából nem használja az alkalmazásunk futás közben, üres a persistence.xml.)</p>
</li>
<li>
<p>A <code>ConnectionProperties</code> az előző konfig fájl egy részének Java-beli reprezentációja</p>
</li>
<li>
<p>A <code>WebshopApplication</code> a Spring Boot alkalmazás belépési pontja és konfigja is. Egy hagyományos webalkalmazást egy külön processzben futó webkonténerre (pl. Tomcat, Jetty) kellene telepíteni. Spring Boot-os fejlesztés esetében viszont maga a Spring Boot fog elindítani egy beágyazott webkonténert (alapértelmezésben Tomcat-et). A <code>tomcatFactory</code> metódusban regisztráljuk be az SQL Server JDBC driverét jdbc/termekDB JNDI néven, hogy a JPA majd megtalálja. Ha nem adatvez az adatbázisunk neve, akkor a JDBC URL-t módosítani kell a megfelelő sornál: resource.setProperty("url", "jdbc:sqlserver://localhost;database=<strong>adatvez</strong>");</p>
</li>
<li>
<p>A webes felület egyetlen oldal, az <code>src\main\resources\templates\testPage.html</code>. Ebbe nem fogunk majd belenyúlni. Standard html + Thymeleaf-es attribútumok látahtóak benne.</p>
</li>
<li>
<p>WebshopController: a webréteget megvalósító controller osztály, ennek metódusai kezelik az alkalmazáshoz érkező HTTP kéréseket. Jellemzően lekérdezések eredményét akarjuk megjeleníteni az oldalon, ezért a lekérdezés eredményét a modellbe tesszük valamilyen néven, amire hivatkozni tudunk a Thymeleaf segítségével. A <code>//TODO</code> részekre kell majd bekötni az egyes feladatokat megvalósító metódusok meghívását.</p>
</li>
</ol>
<h2 id="feladat-3-entitasok-attekintese">Feladat 3: Entitások áttekintése<a class="headerlink" href="#feladat-3-entitasok-attekintese" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>Az entitások már előre készen a <code>hu.bme.aut.adatvez.webshop.model</code> package-ben találhatók. Ezeket általában vagy kézzel írjuk meg, vagy generáljuk a DB táblákból pl. az Eclipse-es JPA plugin segítségével.</p>
</li>
<li>
<p>Az entitások közül nyissunk meg egyet, pl. <code>Vat</code>, látszik benne a <code>@Entity</code>, a <code>@Id</code> annotáció, illetve a kapcsolatok definiálására <code>@OneToMany</code> vagy <code>@ManyToOne</code></p>
</li>
<li>
<p>Az entitásokhoz a Criteria API használatakor hasznos metamodel osztályok is generálódnak, ezekből nézzünk meg egyet a <code>target\generated-sources\apt</code> alatt (A <code>pom.xml</code>-ben látható maven-precessor-plugin generálja egyébként őket a build során.)</p>
</li>
</ul>
<h2 id="feladat-4-lekerdezesek">Feladat 4: Lekérdezések<a class="headerlink" href="#feladat-4-lekerdezesek" title="Permanent link">&para;</a></h2>
<p>A leképzett adatmodellen fogalmazd meg az alábbi lekérdezéseket! A lekérdezéseket JPA és Spring Data használata esetén több módon is megvalósíthatjuk. Az alábbi feladatokban azt is megadjuk, milyen módon kell elkészíteni a lekérdezést, hogy mindegyikre lássunk példát. Fontos megjegyezni, hogy ezek a módszerre vonatkozó megkötések csak oktatási szempontok miatt szerepelnek, valójában bármelyik módszerrel bármelyik lekérdezés megvalósítható lenne.</p>
<p>Az egyes feladatokat megvalósító metódusokat mindig a <code>WebshopController</code> osztály megfelelő <code>//TODO</code> kommentjeinél kell meghívni, majd a webalkalmazást futtatni és böngészőből tesztelni a
<a href="http://localhost:9080">http://localhost:9080</a> URL-en.</p>
<p><strong>a)</strong> Listázd azon termékek nevét és raktárkészletét, melyből több mint 30 darab van raktáron! Módszer: Spring Data repository interfész, metódusnévből származtatott lekérdezés.</p>
<p><strong>b)</strong> Írj olyan lekérdezést, mely kilistázza azon termékeket, melyből legalább kétszer rendeltek! Módszer: Spring Data repository custom implementációval, injektált EntityManagerrel készített JPQL query.</p>
<p><strong>c)</strong> Listázd ki a legdrágább termék adatait! Módszer: Named query, amelyet Spring Data repository-ból hívunk meg, vagy custom implementációból, injektált EntityManagerrel hívunk meg, vagy a metódusnév és query név egyezése alapján.</p>
<p>Futás közben a Console nézetben látszódnak a Hibernate által generált SQL utasítások az <em>application.properties</em>-beli <code>spring.jpa.show-sql=true</code> konfig miatt.</p>
<h3 id="futtatas">Futtatás<a class="headerlink" href="#futtatas" title="Permanent link">&para;</a></h3>
<p>A projektben megtalálható (a legalsó fájl a Project Explorerben) a <strong>webshop run.launch</strong> nevű konfig fájl. Ezen jobb klikk / <em>Debug As / webshop run</em>. Ez debug módban indítja a Spring Boot maven plugin-t, aminek hatására a beágyazott webkonténer elindul, és böngészőből a <a href="http://localhost:9080">http://localhost:9080</a> URL-en elérhető az alkalmazás. Ha ezt egyszer jobb klikkel megcsináltuk, akkor később a toolbar Debug ikonját lenyitva is megtehetjük:</p>
<p><img alt="Eclipse futtatás" src="images/eclipse-run.png" /></p>
<p>Ha a <em>Debug</em> ikon alatt már ott van a <em>webshop run</em>, akkor az egész fentebb leírt webshop <em>run.launch</em>-os módszer szükségtelen.</p>
<p>A futó alkalmazást a <em>Console</em> nézet piros <em>Terminate</em> ikonjával lehet leállítani. Ha leállítás nélkül próbáljuk újra futtatni, akkor a második processz ütközést jelent a 8080-as porton, és leáll. Ilyenkor a sikertelen második futtatás látszik a <em>Console</em> nézetben, a <em>Terminate</em> gomb pedig inaktív, mivel ez a futás már leállt. Nyomjuk meg a Terminate ikon melletti dupla szürke X ikont, ez el fogja távolítani a már leállított futtatásokat, és csak az aktív futtatás látszik, amin viszont már tudunk <em>Terminate</em>-et nyomni.</p>
<p>Ha a teljes <em>Console</em> nézetet bezárjuk véletlenül, elő lehet szedni <em>Alt+Shift+Q, C</em> gyorsbillenytűvel, vagy <em>Window / Show View / Console</em> menüvel.</p>
<p>A leállítás utáni újrafuttatáshoz az F11-et is használhatjuk.</p>
<p>A debug módban való futtatás jellegzetessége, hogy a HTML és bizonyos Java kód módosítások azonnal életbe lépnek. (A böngészőt persze frissíteni kell.) Újra kell viszont indítani az alkalmazást, ha a Java kódban:</p>
<ul>
<li>új típust adtunk hozzá</li>
<li>annotációt adtunk hozzá/töröltünk/módosítottunk</li>
<li>új osztály- vagy tagváltozót, metódust vettünk fel</li>
<li>metódus szignatúrát módosítottunk</li>
</ul>
<p>Röviden: a metódus törzsön belüli változásokon kívül mindig újraindítás lesz szükséges.</p>
<details><summary markdown="span">Megoldás</summary>

### 4.a feladat

Nyissuk meg a `dao` package-ben lévő `ProductRepository` interfészt, amely a Spring Data-s `JpaRepository`-ból származik (és az egyelőre üres `ProductRepositoryCustom`-ból). Találunk benne későbbi feladathoz kapcsolódó metódusokat, azokat csak figyeljük meg. Valamelyik `@Query` annotációval definiálja a futtatandó lekérdezést, valamelyiknél az is hiányzik. Nekünk sem lesz szükség `@Query` annotációra, mert a metódus neve alapján a Spring Data képes kitalálni a query-t. Tegyük tehát bele ezt az új metódust:

<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">hu.bme.aut.adatvez.webshop.dao</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.math.BigDecimal</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">hu.bme.aut.adatvez.webshop.model.Product</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ProductRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Product</span><span class="p">,</span> <span class="n">Long</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">ProductRepositoryCustom</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">Product</span><span class="o">&gt;</span> <span class="nf">findByStockGreaterThan</span><span class="p">(</span><span class="n">BigDecimal</span> <span class="n">limit</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

A `WebshopController`-ben már be van injektálva egy `ProductRepository` típusú tagváltozó, hívjuk meg rajta a metódust az 4.a TODO-nál:

<div class="highlight"><pre><span></span><code><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebshopController</span> <span class="p">{</span>

  <span class="nd">@Autowired</span>
  <span class="n">ProductRepository</span> <span class="n">productRepository</span><span class="p">;</span>

  <span class="c1">//...</span>
  <span class="c1">// 4.a feladat</span>
  <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Product</span><span class="o">&gt;</span> <span class="nf">findProductsOver30</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">productRepository</span><span class="p">.</span><span class="na">findByStockGreaterThan</span><span class="p">(</span><span class="n">BigDecimal</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="mi">30</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

### 4.b feladat

A `dao` package-ben lévő `ProductRepositoryCustom` interfészbe vegyük fel egy `findProductsOrderedAtLeastTwice` nevű metódust:

<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">hu.bme.aut.adatvez.webshop.dao</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">hu.bme.aut.adatvez.webshop.model.Product</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ProductRepositoryCustom</span> <span class="p">{</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">Product</span><span class="o">&gt;</span> <span class="nf">findProductsOrderedAtLeastTwice</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

A dao package-ben lévő `ProductRepositoryImpl` osztály hibás lesz emiatt, mert nem implementálja a `ProductRepositoryCustom`-ot. Nyissuk meg az osztályt, és az osztály elején, a sor elején megjelenő kis villanykörtére kattintva belegeneráltathatjuk a nem implementált metódus vázát:

![Eclise interfész implementálása](images/eclipse-implement-methods.png)

Utána a törzsbe írhatjuk az implementációt, melynek lényege: injektált EntityManager-rel hozzuk létre és futtatjuk le a query-t. (Most látszik igazán, hogy az előző, Spring Data-s megoldás mennyi boilerplate kódot spórolt meg nekünk.)

<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">hu.bme.aut.adatvez.webshop.dao</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">hu.bme.aut.adatvez.webshop.model.Product</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.persistence.EntityManager</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.PersistenceContext</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProductRepositoryImpl</span> <span class="kd">implements</span> <span class="n">ProductRepositoryCustom</span> <span class="p">{</span>

  <span class="nd">@PersistenceContext</span>
  <span class="n">EntityManager</span> <span class="n">em</span><span class="p">;</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Product</span><span class="o">&gt;</span> <span class="nf">findProductsOrderedAtLeastTwice</span><span class="p">(){</span>
    <span class="k">return</span> <span class="n">em</span><span class="p">.</span><span class="na">createQuery</span><span class="p">(</span><span class="s">&quot;SELECT DISTINCT p FROM Product p</span>
<span class="s">                           LEFT JOIN FETCH p.orderitems</span>
<span class="s">                           WHERE size(p.orderitems) &gt;= :itemsMin&quot;</span><span class="p">,</span> <span class="n">Termek</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
          <span class="p">.</span><span class="na">setParameter</span><span class="p">(</span><span class="s">&quot;itemsMin&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
          <span class="p">.</span><span class="na">getResultList</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

Megjegyzés a megoldáshoz: az első ötletünk ez lehetne: `SELECT p FROM Product p WHERE size(p.orderitems) /= :itemsMin`. Írjuk be és próbáljuk ki előbb ezt, ilyenkor viszont `org.hibernate.LazyInitializationException` dobódik teszteléskor, mert lecsatolt állapotban akarunk kapcsolódó entitást elérni (amikor a táblázatot generálja a webréteg, és a orderitems listára hivatkozunk). Lehetséges megoldások:

- Az _application.properties_-ben `spring.jpa.open-in-view=true` (ez lenne amúgy a default Spring Boot esetében, de a példa projektben direkt false-ra van állítva): Ilyenkor az EntityManager már a webes kérés legelején létrejön, és csak a view renderelése után záródik be, vagyis a Spring bean-beli metódusok visszatérése után is menedzselt állapotban lenne a Product entitás, és el lehetne kérni a kapcsolódó orderitems listát.
- vagy `@OneToMany(fetch=EAGER)` a orderitems változóra
- vagy _EntityGraph_ definiálása és annak alkalmazása a query létrehozásakor
- vagy `LEFT JOIN FETCH`, mi ezt választottuk a fenti megoldásban. E mellé a `DISTINCT` is kell, különben minden kapcsolódó Orderitem példányra külön Product sor is lesz.

A meghívás a `WebshopController`-ben triviális:

<div class="highlight"><pre><span></span><code><span class="c1">// 4.b feladat</span>
<span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Product</span><span class="o">&gt;</span> <span class="nf">findProductsOrderedAtLeastTwice</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// TODO</span>
  <span class="k">return</span> <span class="n">productRepository</span><span class="p">.</span><span class="na">findProductsOrderedAtLeastTwice</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

### 4.c feladat

A `Product` osztályt nyissuk meg, ott a gyorsabb haladás érdekében már fogunk találni kész named query-ket, a másodikat kell használnunk:

<div class="highlight"><pre><span></span><code><span class="nd">@NamedQueries</span><span class="p">({</span>
<span class="nd">@NamedQuery</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Product.findAll&quot;</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="s">&quot;SELECT p FROM Product p&quot;</span><span class="p">),</span>
<span class="nd">@NamedQuery</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Product.findMostExpensive&quot;</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="s">&quot;SELECT p FROM Product p WHERE p.price IN (SELECT MAX(p2.price) FROM Product p2)&quot;</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div>

A named query-t két módon is meghívhatjuk. Ha lassú a haladás, elég az első módszerrel megcsinálni. Az első módszer, hogy a named query-vel egyező nevű metódust teszünk a `ProductRepository`-ba (leszámítva a _Product._ előtagot.) Vagyis:

<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Product</span><span class="o">&gt;</span> <span class="nf">findMostExpensive</span><span class="p">();</span>
</code></pre></div>

A másik lehetőség, hogy a `ProductRepositoryImpl`-ben, `EntityManager`-en keresztül hívjuk meg a named query-t:

<div class="highlight"><pre><span></span><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Product</span><span class="o">&gt;</span> <span class="nf">findMostExpensiveProducts</span><span class="p">(){</span>
  <span class="k">return</span> <span class="n">em</span><span class="p">.</span><span class="na">createNamedQuery</span><span class="p">(</span><span class="s">&quot;Product.findMostExpensive&quot;</span><span class="p">,</span> <span class="n">Product</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">getResultList</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

Ilyenkor ezt a metódust ki kell még tenni a `ProductRepositoryCustom` interfészbe. Leggyorsabb így: Jobb klikk / _Refactor / Pull up_, és ott a metódus kiválasztható

Végül valamelyik verziót hívjuk meg a `WebshopController` megfelelő pontján:

<div class="highlight"><pre><span></span><code><span class="c1">// 4.c feladat</span>
<span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Product</span><span class="o">&gt;</span> <span class="nf">findMostExpensiveProducts</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// TODO</span>
  <span class="c1">// return productRepository.findMostExpensiveProducts();</span>
  <span class="k">return</span> <span class="n">productRepository</span><span class="p">.</span><span class="na">findMostExpensive</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

</details>

<h2 id="feladat-5-adatmodositas">Feladat 5: Adatmódosítás<a class="headerlink" href="#feladat-5-adatmodositas" title="Permanent link">&para;</a></h2>
<p>A JPA nemcsak lekérdezéshez használható, hanem rajta keresztül módosítások is végrehajthatóak.</p>
<p><strong>a)</strong> Írj olyan JPQL lekérdezést a <code>ProductRepository</code> interfészbe, mely a "Building items" árát megemeli 10 százalékkal!</p>
<p><strong>b)</strong> Írj egy olyan metódust, amely létrehoz egy új kategóriát "Expensive toys" névvel, ha még nem létezik ilyen, és sorold át ide az összes olyan terméket, melynek ára, nagyobb, mint 8000 Ft!</p>
<p><strong>c)</strong> Egyszerű önálló feladat: az 5.b feladat közös megoldásában egy <code>EntityManager</code>-en keresztül lefuttatott lekérdezéssel ellenőrizzük, hogy létezik-e "Expensive toys" nevű kategória. Valósítsd meg ugyanezt a lekérdezést Spring Data repository interfészben, metódus névből származtatott lekérdezéssel, és hívd meg a megfelelő ponton.</p>
<details><summary markdown="span">Megoldás</summary>

### 5.a feladat

A `ProductRepository` interfészben egy _UPDATE query_-t definiálunk. Azt, hogy ez módosító query, közölni kell a Spring Data-val (`@Modifying`), valamint tranzakcióba is kell tennünk `@Transactional`, az `org.springframework...` package-ből):

<div class="highlight"><pre><span></span><code><span class="nd">@Modifying</span>
<span class="nd">@Transactional</span>
<span class="nd">@Query</span><span class="p">(</span><span class="s">&quot;UPDATE Product p SET p.price=p.price*1.1 WHERE t.id IN</span>
<span class="s">(SELECT p2.id FROM Product p2 WHERE p2.category.name=:categoryName)&quot;</span><span class="p">)</span>
<span class="kt">void</span> <span class="nf">categoryRaisePrice</span><span class="p">(</span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;categoryName&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">categoryName</span><span class="p">);</span>
</code></pre></div>

Meghívása a `WebshopController`-ből:

<div class="highlight"><pre><span></span><code><span class="c1">// 5.a feladat</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/raisePriceOfBuildingItems&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">,</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span> <span class="p">})</span>
<span class="kd">private</span> <span class="n">String</span> <span class="nf">raisePriceOfBuildingItems</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// TODO</span>
  <span class="n">productRepository</span><span class="p">.</span><span class="na">categoryRaisePrice</span><span class="p">(</span><span class="s">&quot;Building items&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="s">&quot;redirect:/&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

Böngészőben a gomb megnyomása után a gomb alatti táblázatban látszódik az átárazás hatása.

#### 5.b feladat

A `dao` package-be új osztály, `CategoryService` néven, `@Service` annotációval, szintén `@Transactional` metódussal:

<div class="highlight"><pre><span></span><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CategoryService</span> <span class="p">{</span>

  <span class="nd">@PersistenceContext</span>
  <span class="kd">private</span> <span class="n">EntityManager</span> <span class="n">em</span><span class="p">;</span>

  <span class="nd">@Autowired</span>
  <span class="n">ProductRepository</span> <span class="n">productRepository</span><span class="p">;</span>

  <span class="nd">@Transactional</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">moveToExpensiveToys</span><span class="p">(</span><span class="kt">double</span> <span class="n">priceLimit</span><span class="p">){</span>
    <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Expensive toys&quot;</span><span class="p">;</span>
    <span class="n">Category</span> <span class="n">categoryExpensive</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="n">resultList</span> <span class="o">=</span>
      <span class="n">em</span><span class="p">.</span><span class="na">createQuery</span><span class="p">(</span><span class="s">&quot;SELECT c from Category c WHERE c.name=:name&quot;</span><span class="p">,</span> <span class="n">Category</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
        <span class="p">.</span><span class="na">setParameter</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="p">.</span><span class="na">getResultList</span><span class="p">();</span>

    <span class="k">if</span><span class="p">(</span><span class="n">resultList</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">()){</span>
      <span class="c1">//0 vagy null id érték esetén fog a @GeneratedValue működésbe lépni. Most primitív long az id-nk, az csak 0 tud lenni, null nem.</span>
      <span class="n">categoryExpensive</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Category</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
      <span class="n">em</span><span class="p">.</span><span class="na">persist</span><span class="p">(</span><span class="n">categoryExpensive</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">categoryExpensive</span> <span class="o">=</span> <span class="n">resultList</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Product</span><span class="o">&gt;</span> <span class="n">expensiveProducts</span> <span class="o">=</span> <span class="n">productRepository</span><span class="p">.</span><span class="na">findByPriceGreaterThan</span><span class="p">(</span><span class="n">priceLimit</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">Product</span> <span class="n">product</span> <span class="p">:</span> <span class="n">expensiveProducts</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">categoryExpensive</span><span class="p">.</span><span class="na">addProduct</span><span class="p">(</span><span class="n">product</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

Figyeljük meg, hogy a menedzselt entitás példányokat (amit tranzakción belül találunk meg query-vel, vagy most persist-áltunk frissen) nem kell explicit módon visszamenteni, tranzakció végén automatikusan DB-be íródnak a memóriabeli változások.

Meghívás a `WebshopController`-ből:

<div class="highlight"><pre><span></span><code><span class="nd">@Autowired</span>
<span class="n">CategoryService</span> <span class="n">categoryService</span><span class="p">;</span>
<span class="p">...</span>

<span class="c1">// 5.b feladat</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/moveToExpensiveToys&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">,</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span> <span class="p">})</span>
<span class="kd">private</span> <span class="n">String</span> <span class="nf">moveToExpensiveToys</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// TODO</span>
  <span class="n">categoryService</span><span class="p">.</span><span class="na">moveToExpensiveToys</span><span class="p">(</span><span class="mf">8000.0</span><span class="p">);</span>
  <span class="k">return</span> <span class="s">&quot;redirect:/&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

Böngészőben a gomb megnyomása után látszódik a _Drága játékok_ kategória tartalma

#### 5.c feladat

A `dao` package-be új interfész, `CategoryRepository` néven, a `ProductRepository` mintájára (a Custom-os leszármazás nem kell, mert nem lesznek custom lekérdezéseink) egy metódussal:

<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CategoryRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Category</span><span class="p">,</span> <span class="n">Long</span><span class="o">&gt;</span><span class="p">{</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="nf">findByName</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

Ezután a `CategoryService` így egyszerűsödik le:

<div class="highlight"><pre><span></span><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CategoryService</span> <span class="p">{</span>
<span class="p">...</span>

  <span class="nd">@Autowired</span>
  <span class="n">CategoryRepository</span> <span class="n">categoryRepository</span><span class="p">;</span>

  <span class="nd">@Transactional</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">moveToExpensiveToys</span><span class="p">(</span><span class="kt">double</span> <span class="n">priceLimit</span><span class="p">){</span>
    <span class="c1">// ...</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="n">resultList</span> <span class="o">=</span> <span class="n">categoryRepository</span><span class="p">.</span><span class="na">findByName</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
    <span class="c1">//  ...</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

</details>

<h2 id="feladat-6-tarolt-eljarasok-hasznalata">Feladat 6: Tárolt eljárások használata<a class="headerlink" href="#feladat-6-tarolt-eljarasok-hasznalata" title="Permanent link">&para;</a></h2>
<p>Hívd meg a JPA-ból a <em>CreateNewPaymentMethod</em> nevű tárolt eljárást, mely új fizetési mód rögzítésére szolgál, és visszaadja az új rekord azonosítóját!</p>
<ul>
<li>
<p>Az SQL Server Management Studioban ellenőrizzük, hogy az adatbázis tartalmazza-e a <em>CreateNewPaymentMethod</em> nevű tárolt eljárást!</p>
</li>
<li>
<p>Ha nem, akkor az alábbi kódot futtasd le a Management Studioban a tárolt eljárás létrehozásához!</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="n">CreateNewPaymentMethod</span>
<span class="p">(</span>
<span class="o">@</span><span class="k">Method</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
<span class="o">@</span><span class="n">Deadline</span> <span class="nb">int</span>
<span class="p">)</span>
<span class="k">AS</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">PaymentMethod</span>
<span class="k">values</span><span class="p">(</span><span class="o">@</span><span class="k">Method</span><span class="p">,</span><span class="o">@</span><span class="n">Deadline</span><span class="p">)</span>
<span class="k">select</span> <span class="n">scope_identity</span><span class="p">()</span> <span class="k">as</span> <span class="n">NewId</span>
</code></pre></div>

<details><summary markdown="span">Megoldás</summary>

A `PaymentMethod` entitáson megtaláljuk az alábbi annotációt. Vessük össze a tárolt eljárást definiáló kóddal a változó neveket!

<div class="highlight"><pre><span></span><code><span class="nd">@NamedStoredProcedureQueries</span><span class="p">({</span>
    <span class="nd">@NamedStoredProcedureQuery</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;createMethodSP&quot;</span><span class="p">,</span>
            <span class="n">procedureName</span> <span class="o">=</span> <span class="s">&quot;CreateNewPaymentMethod&quot;</span><span class="p">,</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nd">@StoredProcedureParameter</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="n">ParameterMode</span><span class="p">.</span><span class="na">IN</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Method&quot;</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">),</span>
                <span class="nd">@StoredProcedureParameter</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="n">ParameterMode</span><span class="p">.</span><span class="na">IN</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Deadline&quot;</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">BigDecimal</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
            <span class="p">})</span>
<span class="p">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Paymentmethod</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>
<span class="p">...</span>
</code></pre></div>

A named stored procedure query meghívható Spring Data repositoryból (`dao` package-en _New Interface ... / PaymentmethodRepository_):

<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PaymentmethodRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Paymentmethod</span><span class="p">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="p">{</span>

  <span class="nd">@Procedure</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;createMethodSP&quot;</span><span class="p">)</span>
  <span class="kt">void</span> <span class="nf">newMethod</span><span class="p">(</span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;Method&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">method</span><span class="p">,</span> <span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;Deadline&quot;</span><span class="p">)</span> <span class="n">BigDecimal</span> <span class="n">deadline</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

Spring Data nélkül így menne, `EntityManager`-en keresztül, erre valószínűleg már nem lesz idő:

<div class="highlight"><pre><span></span><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentmethodService</span> <span class="p">{</span>

  <span class="nd">@PersistenceContext</span>
  <span class="kd">private</span> <span class="n">EntityManager</span> <span class="n">em</span><span class="p">;</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createNewMethod</span><span class="p">(</span><span class="n">Paymentmethod</span> <span class="n">paymentMethod</span><span class="p">){</span>
    <span class="n">StoredProcedureQuery</span> <span class="n">sp</span> <span class="o">=</span> <span class="n">em</span><span class="p">.</span><span class="na">createNamedStoredProcedureQuery</span><span class="p">(</span><span class="s">&quot;createMethodSP&quot;</span><span class="p">);</span>
    <span class="n">sp</span><span class="p">.</span><span class="na">setParameter</span><span class="p">(</span><span class="s">&quot;Method&quot;</span><span class="p">,</span> <span class="n">paymentMethod</span><span class="p">.</span><span class="na">getMethod</span><span class="p">());</span>
    <span class="n">sp</span><span class="p">.</span><span class="na">setParameter</span><span class="p">(</span><span class="s">&quot;Deadline&quot;</span><span class="p">,</span> <span class="n">paymentMethod</span><span class="p">.</span><span class="na">getDeadline</span><span class="p">());</span>
    <span class="n">sp</span><span class="p">.</span><span class="na">execute</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

A webrétegbeli meghívás:

- Injektáljuk a `WebshopController`-be a `PaymentmethodRepository` interfészt:

<div class="highlight"><pre><span></span><code><span class="nd">@Autowired</span>
<span class="n">PaymentmethodRepository</span> <span class="n">paymentmethodRepository</span><span class="p">;</span>
</code></pre></div>

- A WebshopController utolsó TODO-jánál hívjuk meg

<div class="highlight"><pre><span></span><code><span class="n">paymentmethodRepository</span><span class="p">.</span><span class="na">newMethod</span><span class="p">(</span><span class="n">paymentMethod</span><span class="p">.</span><span class="na">getMod</span><span class="p">(),</span> <span class="n">paymentMethod</span><span class="p">.</span><span class="na">getHatarido</span><span class="p">());</span>
</code></pre></div>

- A `Paymentmethod` entitás `deadline` és `method` tagváltozóin validációs _constraint_-eket találunk. Ezek az annotációk a _Bean Validation API_ részei, amivel a webes rétegben használt Spring MVC, de a JPA és integrálódik, így a webrétegbeli és adatrétegbeli validáció konzisztens módon, redundanciamentesen definiálható.

<div class="highlight"><pre><span></span><code><span class="nd">@NotNull</span>
<span class="kd">private</span> <span class="n">BigDecimal</span> <span class="n">deadline</span><span class="p">;</span>

<span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;METHOD&quot;</span><span class="p">)</span>
<span class="nd">@NotEmpty</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">method</span><span class="p">;</span>
</code></pre></div>

</details>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        

<!-- Application footer -->
<footer class="md-footer">

  <!-- Link to previous and/or next page -->
  

  <!-- Further information -->
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">

      <!-- Copyright and theme information -->
      <div class="md-footer-copyright">
        
        <div class="md-footer-copyright__highlight">
          Copyright &copy; BME AUT
        </div>
        
      </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.d710d30a.min.js"></script>
      <script src="../../assets/javascripts/bundle.b39636ac.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "M\u00e1sol\u00e1s v\u00e1g\u00f3lapra", "clipboard.copied": "V\u00e1g\u00f3lapra m\u00e1solva", "search.config.lang": "hu", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Keres\u00e9shez \u00edrj ide valamit", "search.result.none": "Nincs tal\u00e1lat", "search.result.one": "1 egyez\u0151 dokumentum", "search.result.other": "# egyez\u0151 dokumentum"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: ["tabs"],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.a68abb33.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>